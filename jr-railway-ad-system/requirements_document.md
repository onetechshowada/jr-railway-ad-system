# 鉄道データを活用した配信条件 - 要件定義書

## 📋 目次

1. ユースケース分析サマリー
2. 必要な鉄道データ項目の整理
3. 既存データと不足データのギャップ分析
4. 配信条件の要件定義
5. UI設計への提言

---

## 1. ユースケース分析サマリー

### 1.1 全体概要

- **総ユースケース数**: 31件
- **広告主タイプ**
  - リアル店舗: 16件（51.6%）
  - ネットビジネス: 15件（48.4%）

- **配信目的**
  - 来店/来場誘導: 17件（54.8%）
  - ブランディング: 12件（38.7%）
  - ネット購入誘導: 2件（6.5%）

### 1.2 データ活用状況

- **鉄道利用データ**: 28件（90.3%）が活用
- **購入データ（カード決済）**: 13件（41.9%）が活用
- **気象データ**: 20件（64.5%）が活用

### 1.3 鉄道データ活用パターンTOP5

1. **通勤/通学定期データ**: 22件（71.0%）
2. **マイ駅データ**: 16件（51.6%）
3. **改札記録データ**: 9件（29.0%）
4. **マイ区間データ**: 8件（25.8%）
5. **切符購入データ**: 2件（6.5%）

---

## 2. 必要な鉄道データ項目の整理

### 2.1 配信条件として必要なデータ項目

#### 【A. 駅・区間データ】

| データ項目 | ニーズ | 現在の保有状況 | 取得元テーブル |
|---|---|---|---|
| **通勤定期（発駅・着駅）** | ⭐⭐⭐ 非常に高 | ⚠️ 推定（ICOCA定期） | ICOCA一件明細 |
| **通学定期（発駅・着駅）** | ⭐⭐⭐ 非常に高 | ⚠️ 推定（ICOCA定期） | ICOCA一件明細 |
| **マイ駅（頻繁に利用する駅）** | ⭐⭐⭐ 非常に高 | ✅ 存在 | 会員情報（自宅最寄駅） + ICOCA出改札集計 |
| **マイ区間（頻繁に利用する区間）** | ⭐⭐ 高 | ❌ 不足 | ICOCA出改札を集計・分析して生成 |
| **入場駅・出場駅（リアルタイム）** | ⭐⭐⭐ 非常に高 | ✅ 存在 | ICOCA出改札ID管理 |
| **通過駅（経路推定）** | ⭐⭐ 高 | ❌ 不足 | 外部：経路検索API |

#### 【B. 利用履歴データ】

| データ項目 | ニーズ | 現在の保有状況 | 取得元テーブル |
|---|---|---|---|
| **切符購入履歴（予約）** | ⭐⭐ 高 | ✅ 存在 | 予約確定(e5489)、行程確定、列車確定 |
| **切符購入予定（未来）** | ⭐⭐⭐ 非常に高 | ✅ 存在 | 予約確定(e5489) - 乗車日 |
| **ICOCA利用履歴** | ⭐⭐⭐ 非常に高 | ✅ 存在 | ICOCA一件明細、ICOCA出改札 |
| **利用頻度（週/月単位）** | ⭐⭐ 高 | ⚠️ 集計必要 | ICOCA出改札 → 集計処理 |
| **定期的な利用パターン** | ⭐⭐ 高 | ❌ 不足 | ICOCA出改札 → AI分析 |

#### 【C. 時間帯データ】

| データ項目 | ニーズ | 現在の保有状況 | 取得元テーブル |
|---|---|---|---|
| **入場時刻・出場時刻** | ⭐⭐⭐ 非常に高 | ✅ 存在 | ICOCA出改札ID管理 |
| **帰宅時刻の推定** | ⭐⭐⭐ 非常に高 | ⚠️ 集計必要 | ICOCA出改札 → 集計・分析 |
| **通勤時間帯の特定** | ⭐⭐ 高 | ⚠️ 集計必要 | ICOCA出改札 → 集計・分析 |

#### 【D. 属性データ】

| データ項目 | ニーズ | 現在の保有状況 | 取得元テーブル |
|---|---|---|---|
| **ビジネスパーソン判定** | ⭐⭐⭐ 非常に高 | ⚠️ 推定可能 | 通勤定期の有無 + 年代 |
| **学生判定** | ⭐⭐⭐ 非常に高 | ⚠️ 推定可能 | 通学定期の有無 |
| **大学生判定** | ⭐⭐ 高 | ❌ 困難 | 年齢推定（18-22歳） |
| **子供がいる可能性** | ⭐ 中 | ⚠️ 推定可能 | 年代（30-50代） |

#### 【E. 購買データ（カード決済）】

| データ項目 | ニーズ | 現在の保有状況 | 取得元テーブル |
|---|---|---|---|
| **自社商品購入履歴** | ⭐⭐⭐ 非常に高 | ✅ 存在 | カード事業テーブル |
| **競合店舗利用履歴** | ⭐⭐⭐ 非常に高 | ✅ 存在 | カード事業テーブル |
| **特定カテゴリ購入履歴** | ⭐⭐⭐ 非常に高 | ✅ 存在 | カード事業テーブル |
| **ガソリンスタンド利用** | ⭐⭐ 高 | ✅ 存在 | カード事業テーブル |
| **ジム会員** | ⭐⭐ 高 | ✅ 存在 | カード事業テーブル |

---

## 3. 既存データと不足データのギャップ分析

### 3.1 ✅ すでに保有しているデータ

#### **【高精度で利用可能】**

1. **ICOCA出改札記録**
   - 入場駅・出場駅
   - 入場時刻・出場時刻
   - 利用日
   - 運賃金額

2. **e5489予約データ**
   - 発駅・着駅
   - 乗車日（未来の予定含む）
   - 予約日
   - 利用目的（アンケート区分）

3. **会員基本情報**
   - 自宅最寄駅
   - 通勤・通学先
   - 年代・性別・居住地

4. **カード決済データ**
   - 利用店舗カテゴリ
   - 利用金額
   - 利用年月

---

### 3.2 ⚠️ 推定・加工が必要なデータ

| データ項目 | 推定・加工方法 | 精度 | 実装難易度 |
|---|---|---|---|
| **通勤定期（発着駅）** | ICOCA一件明細から定期券種別を判定 + 頻出発着駅ペアを抽出 | 中〜高 | 中 |
| **通学定期（発着駅）** | ICOCA一件明細から定期券種別を判定 + 頻出発着駅ペアを抽出 + 年齢フィルタ | 中〜高 | 中 |
| **マイ駅** | ICOCA出改札記録から過去30日間の駅別利用回数を集計しTOP3を抽出 | 高 | 低 |
| **マイ区間** | ICOCA出改札記録から過去30日間の駅ペア利用回数を集計しTOP3を抽出 | 中〜高 | 中 |
| **帰宅時刻推定** | ICOCA出改札記録から平日夕方の出場時刻の平均を算出 | 中 | 低 |
| **ビジネスパーソン判定** | （通勤定期あり OR 平日朝夕の定期的な駅利用あり）AND 年齢23歳以上 | 中〜高 | 低 |
| **学生判定** | （通学定期あり OR 大学最寄駅の定期利用あり）AND 年齢15-22歳 | 中 | 低 |
| **利用頻度** | ICOCA出改札記録から週次・月次の利用回数を集計 | 高 | 低 |

---

### 3.3 ❌ 完全に不足しているデータ（外部連携必要）

| データ項目 | 不足理由 | 代替案・外部データソース |
|---|---|---|
| **通過駅（経路）** | 駅ペアからの経路推定ロジックが未実装 | 【推奨】駅すぱあと API / Yahoo!路線情報API / Google Maps Directions API |
| **運行情報（遅延・運休）** | リアルタイム運行データなし | 【必須】JR西日本運行情報システムAPI |
| **混雑度** | リアルタイム混雑データなし | 【オプション】JR西日本混雑情報API |
| **駅周辺施設情報** | 駅周辺のPOI（店舗・施設）データなし | 【推奨】Google Places API / ゼンリン地図API |
| **定期券種別の明示的な判定** | ICOCA一件明細に定期券種別フラグが不明 | 【確認必要】ICOCAテーブルに定期フラグが存在するか確認 |

---

## 4. 配信条件の要件定義

### 4.1 新規追加する配信条件カテゴリ

既存の気象データ条件と同様の構造で、以下の鉄道データ条件を追加します。

---

#### 📍 **【新規カテゴリ1】 駅・区間条件**

##### **① 特定駅の利用**

**配信条件名**: 特定駅利用者

**設定項目**:
- **対象駅**: 駅名検索 or 駅コード入力（複数選択可）
- **利用期間**: 
  - 過去〇日間（7日/14日/30日/60日/90日/180日/365日）
  - カスタム期間（開始日〜終了日）
- **利用回数**: 
  - 〇回以上/〇回以下/〇回〜〇回
  - スライダーで設定（0回〜50回以上）
- **利用種別**: 
  - ☑ 入場駅として利用
  - ☑ 出場駅として利用
  - ☑ どちらでも可

**比較演算子**: 以上/以下/範囲指定/等しい

**いつの利用**: 
- ☑ 平日のみ
- ☑ 休日のみ
- ☑ 全日
- 曜日指定（月/火/水/木/金/土/日）

**AND/OR ロジック**: 複数条件の組み合わせ可能

**UI イメージ**:
```
┌─────────────────────────────────────┐
│ 特定駅利用者                          │
├─────────────────────────────────────┤
│ 対象駅: [大阪駅 ▼] [+ 駅を追加]         │
│                                      │
│ 利用期間: [過去30日間 ▼]              │
│                                      │
│ 利用回数: [━━●━━━━━] 5回以上          │
│           0        25        50+     │
│                                      │
│ 利用種別: ☑ 入場駅 ☑ 出場駅           │
│                                      │
│ いつの利用:                           │
│ ☑ 月 ☑ 火 ☑ 水 ☑ 木 ☑ 金 □ 土 □ 日 │
│                                      │
│ [条件を追加] [AND] [OR]               │
└─────────────────────────────────────┘
```

---

##### **② マイ駅（頻繁に利用する駅）**

**配信条件名**: マイ駅設定者

**説明**: ユーザーが頻繁に利用する駅（過去の利用実績から自動抽出）

**設定項目**:
- **対象駅**: 駅名検索 or 駅コード入力（複数選択可）
- **マイ駅の定義期間**: 過去30日/60日/90日
- **マイ駅順位**: 
  - 第1位のマイ駅
  - 第1位〜第3位のマイ駅
  - マイ駅（TOP5）

**比較演算子**: 一致する/含まれる

**いつの利用**: （特定駅利用と同様）

---

##### **③ 区間利用（発着駅ペア）**

**配信条件名**: 特定区間利用者

**設定項目**:
- **発駅**: 駅名検索（複数選択可）
- **着駅**: 駅名検索（複数選択可）
- **方向**: 
  - ☑ 発→着のみ
  - ☑ 着→発のみ
  - ☑ 往復どちらでも
- **利用期間**: 過去〇日間
- **利用回数**: 〇回以上/以下/範囲

**UI イメージ**:
```
┌─────────────────────────────────────┐
│ 特定区間利用者                        │
├─────────────────────────────────────┤
│ 発駅: [大阪駅 ▼]                     │
│  ↓                                   │
│ 着駅: [京都駅 ▼]                     │
│                                      │
│ 方向: ◉ 発→着のみ ○ 往復どちらでも   │
│                                      │
│ 利用期間: [過去30日間 ▼]              │
│ 利用回数: [━━●━━━━━] 10回以上        │
└─────────────────────────────────────┘
```

---

##### **④ マイ区間（頻繁に利用する区間）**

**配信条件名**: マイ区間設定者

**説明**: ユーザーが頻繁に利用する区間（過去の利用実績から自動抽出）

**設定項目**:
- **対象区間**: 
  - 発駅 + 着駅の組み合わせ指定
  - エリア指定（大阪エリア⇔京都エリア など）
- **マイ区間の定義期間**: 過去30日/60日/90日

---

##### **⑤ 経路上の駅（通過駅）**

**配信条件名**: 経路上の駅利用者

**説明**: マイ区間・通勤定期の経路上にある駅を条件に設定

**設定項目**:
- **経路種別**: 
  - ○ マイ区間の経路上
  - ○ 通勤定期の経路上
  - ○ 通学定期の経路上
- **対象駅**: 駅名検索（複数選択可）

**⚠️ 外部API必要**: 駅ペアから経路を推定する路線検索APIが必要

**UI イメージ**:
```
┌─────────────────────────────────────┐
│ 経路上の駅利用者                      │
├─────────────────────────────────────┤
│ 経路種別:                             │
│ ◉ マイ区間の経路上                    │
│ ○ 通勤定期の経路上                    │
│                                      │
│ 対象駅: [梅田駅 ▼] [+ 駅を追加]       │
│                                      │
│ ※ ユーザーのマイ区間の経路上に        │
│   指定した駅が含まれる人を抽出します    │
└─────────────────────────────────────┘
```

---

#### 🎫 **【新規カテゴリ2】 定期券・予約条件**

##### **① 通勤定期保有者**

**配信条件名**: 通勤定期利用者

**設定項目**:
- **定期の発着駅指定**: 
  - ☑ 発駅を指定: [駅名検索]
  - ☑ 着駅を指定: [駅名検索]
  - ☑ どちらか片方でも該当すればOK
- **有効期限**: 
  - ○ 現在有効な定期のみ
  - ○ 過去〇ヶ月以内に保有していた定期も含む

**⚠️ データ確認必要**: ICOCAテーブルに定期券フラグ・発着駅情報が存在するか確認

---

##### **② 通学定期保有者**

（通勤定期と同様の設定項目）

---

##### **③ 切符予約者（未来の予定）**

**配信条件名**: 切符予約者（旅マエ配信）

**説明**: 今後〇日以内に特定の駅・区間を利用予定の人

**設定項目**:
- **予約済みの発駅/着駅**: 駅名検索（複数選択可）
- **乗車予定日**: 
  - 今日から〇日後以内（1日/3日/7日/14日/30日）
  - カスタム期間
- **商品種別**: 
  - ☑ 新幹線
  - ☑ 特急
  - ☑ 全て

**ユースケース**: 
- 観光地への旅行者に対して、現地のホテルや飲食店、観光施設を告知
- 出張者に対して、ビジネスホテルを告知

**UI イメージ**:
```
┌─────────────────────────────────────┐
│ 切符予約者（旅マエ配信）              │
├─────────────────────────────────────┤
│ 予約済みの目的地:                     │
│ [金沢駅 ▼] [+ 駅を追加]              │
│                                      │
│ 乗車予定日: [今日から7日後以内 ▼]     │
│                                      │
│ 商品種別: ☑ 新幹線 ☑ 特急            │
│                                      │
│ ※ 旅行前のユーザーに、現地の          │
│   ホテルや観光施設を告知できます      │
└─────────────────────────────────────┘
```

---

##### **④ 切符購入頻度**

**配信条件名**: 切符利用頻度

**設定項目**:
- **期間**: 過去3ヶ月/6ヶ月/1年
- **購入回数**: 〇回以上/以下/範囲
- **商品種別**: 新幹線/特急/全て

**ユースケース**: 出張が多いビジネスパーソン向けにビジネスホテルを訴求

---

#### ⏰ **【新規カテゴリ3】 時間帯条件**

##### **① 帰宅時刻**

**配信条件名**: 帰宅時刻

**説明**: ユーザーの平均的な帰宅時刻に基づく配信

**設定項目**:
- **帰宅時刻**: 
  - スライダー（15:00 〜 24:00）
  - 範囲指定（18:00〜20:00 など）
- **判定方法**: 
  - 過去30日間の平日夕方の出場時刻の平均

**ユースケース**: 
- 帰宅時刻の30分前にデリバリーアプリの広告配信
- 帰宅時刻に合わせて駅ナカ商業施設のセール告知

**UI イメージ**:
```
┌─────────────────────────────────────┐
│ 帰宅時刻                              │
├─────────────────────────────────────┤
│ 帰宅時刻帯:                           │
│ [━━━━━●━━━━] 18:00 〜 20:00         │
│ 15:00      19:00       24:00        │
│                                      │
│ 判定期間: [過去30日間の平均 ▼]        │
│                                      │
│ ※ ユーザーの平日帰宅時刻に             │
│   合わせた広告配信が可能です           │
└─────────────────────────────────────┘
```

---

##### **② リアルタイム駅利用**

**配信条件名**: リアルタイム駅利用

**説明**: 今まさに特定の駅を利用している人（入場/出場から〇分以内）

**設定項目**:
- **対象駅**: 駅名検索（複数選択可）
- **利用種別**: 入場/出場/どちらでも
- **経過時間**: 〇分以内（5分/10分/15分/30分/60分）

**ユースケース**: 
- 駅ナカ商業施設への来店誘導
- タクシーアプリの利用促進（雨天時）

**⚠️ 技術的課題**: 
- リアルタイム性の確保（データ連携の遅延）
- プライバシー配慮（位置情報の利用）

---

#### 👤 **【新規カテゴリ4】 属性・セグメント条件**

##### **① ビジネスパーソン**

**配信条件名**: ビジネスパーソン

**判定ロジック**:
- （通勤定期あり OR 平日朝夕の定期的な駅利用パターンあり）
- AND 年齢23歳以上

**設定項目**:
- 判定精度: ○ 高精度（定期保有者のみ） ○ 推定含む

---

##### **② 学生**

**配信条件名**: 学生

**判定ロジック**:
- （通学定期あり OR 大学最寄駅の定期利用あり）
- AND 年齢15-22歳

**設定項目**:
- 学生種別: ☑ 大学生 ☑ 高校生 ☑ 中学生

---

##### **③ 利用頻度セグメント**

**配信条件名**: 鉄道利用頻度

**設定項目**:
- **期間**: 過去30日/60日/90日
- **利用回数**: 
  - ヘビーユーザー（週5回以上）
  - ミドルユーザー（週2-4回）
  - ライトユーザー（週1回以下）
  - カスタム（〇回以上/以下）

---

#### 💳 **【新規カテゴリ5】 購買履歴条件（カード決済連携）**

##### **① 特定店舗カテゴリ利用者**

**配信条件名**: 特定カテゴリ購買履歴

**設定項目**:
- **店舗カテゴリ**: 
  - ☑ 飲食店
  - ☑ スポーツジム
  - ☑ コンビニ
  - ☑ ドラッグストア
  - ☑ ガソリンスタンド
  - ☑ カー用品店
  - ☑ 航空券
  - ☑ ホテル・旅館
  - ☑ デパート・百貨店
  - ☑ アパレル
  - ☑ コスメ
  - ... その他
- **利用期間**: 過去3ヶ月/6ヶ月/1年
- **利用回数**: 〇回以上/以下/範囲
- **利用金額**: 合計〇円以上/以下/範囲

**ユースケース**:
- ガソリンスタンド利用者 = 車保有者 → 自動車保険・ディーラー広告
- ジム利用者 → 競合ジムの入会キャンペーン
- 航空券購入者 → ホテル予約サイト広告

---

##### **② 競合店舗利用者**

**配信条件名**: 競合店舗利用者

**説明**: 競合店舗での決済履歴がある人をターゲット

**設定項目**:
- **競合店舗名**: テキスト入力 or リストから選択
- **利用期間**: 過去3ヶ月/6ヶ月/1年
- **利用回数**: 〇回以上

**ユースケース**: 競合ジム/飲食店/小売店を利用する人に自社への乗り換えを促す

---

##### **③ 自社商品購入者**

**配信条件名**: 自社商品購入者

**説明**: 自社での過去の購入履歴がある人

**設定項目**:
- **購入履歴の有無**: あり/なし
- **最終購入日**: 〇日以内/〇ヶ月以内
- **購入回数**: 〇回以上/以下

**ユースケース**: 
- 既存顧客への再来店促進
- 新規顧客のみに絞った広告配信

---

#### 🌦️ **【既存】 気象データ条件との組み合わせ**

##### 組み合わせ例

**パターン1: 雨天 × 駅利用 → タクシーアプリ**
```
条件:
- 気象: 降水量 10mm以上
- 鉄道: 特定駅（大阪駅/梅田駅）を今から30分以内に出場予定
→ タクシーアプリのクーポン配信
```

**パターン2: 猛暑 × 帰宅時刻 → デリバリー**
```
条件:
- 気象: 最高気温 33℃以上
- 鉄道: 帰宅時刻が18:00-20:00
- 鉄道: 自宅最寄駅のマイ駅設定者
→ デリバリーサービスの広告配信
```

**パターン3: 週末晴天 × 観光地予約 → ホテル**
```
条件:
- 気象: 土日の天気が「晴れ」
- 鉄道: 金沢駅行きの切符を予約済み（乗車日まで3-7日）
→ 金沢市内のホテル予約サイト広告
```

---

## 5. UI設計への提言

### 5.1 既存の気象データUIとの統一性

既存の気象データ条件設定と同様のUIパターンを踏襲:
- **左サイドバー**: カテゴリ別のアコーディオンメニュー
- **中央エリア**: 条件設定フォーム
- **スライダー**: 数値範囲の設定
- **ドロップダウン**: 比較演算子の選択
- **チェックボックス**: 曜日や種別の選択
- **AND/OR ボタン**: 複数条件の組み合わせ

### 5.2 新規追加するサイドバーメニュー構成案

```
左サイドバー
├─ 気温 [既存]
├─ 気温差 [既存]
├─ 降水量 [既存]
├─ 湿度 [既存]
├─ 風速 [既存]
├─ 1日のまとめ天気 [既存]
├─ 降水確率 [既存]
├─ 最高/最低気温 [既存]
├─ 花粉の飛散量 [既存]
├─ ──────────────
├─ 【NEW】 駅・区間 ★
│   ├─ 特定駅利用者
│   ├─ マイ駅設定者
│   ├─ 特定区間利用者
│   ├─ マイ区間設定者
│   └─ 経路上の駅利用者
├─ 【NEW】 定期券・予約 ★
│   ├─ 通勤定期保有者
│   ├─ 通学定期保有者
│   ├─ 切符予約者（旅マエ）
│   └─ 切符利用頻度
├─ 【NEW】 時間帯 ★
│   ├─ 帰宅時刻
│   └─ リアルタイム駅利用
├─ 【NEW】 属性・セグメント ★
│   ├─ ビジネスパーソン
│   ├─ 学生
│   └─ 鉄道利用頻度
└─ 【NEW】 購買履歴 ★
    ├─ 特定カテゴリ購買
    ├─ 競合店舗利用者
    └─ 自社商品購入者
```

### 5.3 配信条件設定の全体フロー

```
1. キャンペーン名設定
   ↓
2. 地点設定（必須） [既存]
   ↓
3. 気象データ条件設定 [既存]
   │ - 気温、降水量、etc.
   │ - AND/OR で複数条件組み合わせ
   ↓
4. 【NEW】鉄道データ条件設定 ★
   │ - 駅・区間条件
   │ - 定期券・予約条件
   │ - 時間帯条件
   │ - AND/OR で複数条件組み合わせ
   ↓
5. 【NEW】購買履歴条件設定 ★
   │ - カード決済履歴
   │ - AND/OR で複数条件組み合わせ
   ↓
6. 配信対象者プレビュー
   │ - 推定リーチ数表示
   │ - セグメント分布グラフ
   ↓
7. 配信設定・保存
```

### 5.4 駅名検索UIの提案

**駅名入力時のサジェスト機能**:
```
┌─────────────────────────────┐
│ 対象駅: [大阪__________] [🔍] │
│                              │
│ ┌──────────────────────┐    │
│ │ 🚉 大阪駅 (JR西日本)    │    │
│ │ 🚉 大阪梅田駅 (阪急)     │    │
│ │ 🚉 大阪難波駅 (近鉄)     │    │
│ │ 🚉 大阪上本町駅 (近鉄)   │    │
│ └──────────────────────┘    │
└─────────────────────────────┘
```

### 5.5 配信対象者プレビュー機能

**推定リーチ数の表示**:
```
┌────────────────────────────────┐
│ 📊 配信対象者プレビュー          │
├────────────────────────────────┤
│ 推定リーチ数: 約 45,000 人       │
│                                 │
│ ■ 条件内訳                      │
│ ├─ 気象条件: 120,000 人         │
│ ├─ 駅条件: 80,000 人            │
│ └─ 購買条件: 60,000 人          │
│                                 │
│ ■ セグメント分布                │
│ ├─ 年代: 20代 30% / 30代 45% .. │
│ ├─ 性別: 男性 60% / 女性 40%    │
│ └─ 居住地: 大阪 50% / 京都 30% ..│
└────────────────────────────────┘
```

---

## 6. 実装の優先順位

### フェーズ1（初期リリース - 必須）

**Priority: HIGH**

1. ✅ **特定駅利用者**
2. ✅ **マイ駅設定者**
3. ✅ **特定区間利用者**
4. ✅ **切符予約者（旅マエ配信）**
5. ✅ **ビジネスパーソン判定**
6. ✅ **学生判定**
7. ✅ **特定カテゴリ購買履歴**

---

### フェーズ2（機能拡張）

**Priority: MEDIUM**

8. ⚪ **マイ区間設定者**（集計ロジック実装必要）
9. ⚪ **通勤定期保有者**（定期判定ロジック実装必要）
10. ⚪ **通学定期保有者**（定期判定ロジック実装必要）
11. ⚪ **帰宅時刻**（時刻推定ロジック実装必要）
12. ⚪ **鉄道利用頻度**（集計処理実装必要）
13. ⚪ **競合店舗利用者**
14. ⚪ **自社商品購入者**

---

### フェーズ3（高度な機能）

**Priority: LOW（外部API連携必要）**

15. 🔺 **経路上の駅利用者**（路線検索API連携必要）
16. 🔺 **リアルタイム駅利用**（リアルタイムデータ連携必要）
17. 🔺 **運行情報連動**（遅延・運休情報API連携必要）

---

## 7. データ処理パイプライン設計案

### 7.1 バッチ処理（日次/週次）

**処理内容**:
1. ICOCA出改札データから以下を集計・生成:
   - マイ駅（TOP3駅）
   - マイ区間（TOP3駅ペア）
   - 利用頻度（週次/月次）
   - 平均帰宅時刻
   - 通勤定期・通学定期の推定
   
2. カード決済データから以下を抽出:
   - カテゴリ別購買履歴
   - 競合店舗利用フラグ

3. 会員マスタへの付与:
   - ビジネスパーソンフラグ
   - 学生フラグ
   - 利用頻度セグメント

**実行タイミング**: 毎日 AM 4:00（前日分データの集計）

---

### 7.2 リアルタイム処理（オプション）

**処理内容**:
- ICOCA出改札データのストリーミング処理
- 入場/出場から〇分以内の検知
- リアルタイム広告配信トリガー

**技術スタック案**: 
- Apache Kafka / AWS Kinesis
- リアルタイムCEP（Complex Event Processing）

---

## 8. プライバシー・法務対応

### 8.1 プライバシーポリシーの改訂

**追加が必要な記載内容**:

> お客様の鉄道利用データ（乗車駅、降車駅、利用日時など）およびカード決済データを、お客様の興味・関心に合わせた広告配信の目的で利用させていただきます。
>
> また、気象データと組み合わせることで、天候に応じた最適なタイミングでの広告配信を実現します。
>
> これらのデータは、個人を特定しない形で統計処理され、第三者への提供は行いません。

### 8.2 オプトアウト機能

**ユーザーが選択できる設定**:
- ☑ 鉄道利用データの広告利用を許可する
- ☑ カード決済データの広告利用を許可する

**既存の会員情報テーブルに追加するフラグ**:
- `RAILWAY_AD_CONSENT_FLG` (鉄道データ広告利用同意)
- `CARD_AD_CONSENT_FLG` (カード決済データ広告利用同意)

---

## 9. まとめ

### 9.1 実現可能な配信条件

✅ **すぐに実装可能（既存データで対応）**:
- 特定駅利用者
- 特定区間利用者
- 切符予約者（旅マエ配信）
- 特定カテゴリ購買履歴

⚠️ **集計・分析処理が必要**:
- マイ駅/マイ区間
- 通勤定期/通学定期の推定
- 帰宅時刻推定
- ビジネスパーソン/学生判定

❌ **外部API連携が必要**:
- 経路上の駅（通過駅）
- リアルタイム駅利用
- 運行情報連動

---

### 9.2 気象データとの相乗効果

| 組み合わせパターン | 効果 | ユースケース例 |
|---|---|---|
| **雨天 × 駅利用** | ⭐⭐⭐ | タクシーアプリ、デリバリー、駅ナカ商業施設 |
| **猛暑/寒波 × 帰宅時刻** | ⭐⭐⭐ | デリバリー、宅配サービス |
| **晴天 × 観光地予約** | ⭐⭐⭐ | ホテル、観光施設、レンタカー |
| **花粉 × 通勤定期** | ⭐⭐ | 花粉症薬、マスク、空気清浄機 |
| **紫外線 × 通学定期（女性）** | ⭐⭐ | UV対策化粧品、日傘 |

---

### 9.3 推定リーチ数

**J-WEST会員 × 鉄道利用データ連携**:
- Popinfo ID連携後: 約674万ID
- メールアドレス/電話番号ハッシュ化: さらにカバー率向上

**セグメント例**:
- 大阪駅利用者（過去30日）: 約50万人
- 通勤定期保有ビジネスパーソン: 約120万人
- 切符予約者（今後7日以内）: 約8万人
- ジム利用履歴あり: 約15万人

---

## 10. 次のステップ（モックアップ作成へ）

要件定義が完了しましたので、次のステップとして以下を実施します:

✅ **ステップ4完了**: 配信条件の要件定義

▶️ **ステップ5**: UI/UXモックアップの作成

**モックアップに含める内容**:
1. 左サイドバーの新規メニュー構成
2. 各配信条件の設定画面デザイン
3. 駅名検索UIのサジェスト機能
4. 配信対象者プレビュー画面
5. 気象データとの組み合わせ例

---

**📌 承認をいただければ、モックアップの作成に進みます！**

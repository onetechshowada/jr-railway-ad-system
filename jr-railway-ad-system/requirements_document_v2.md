# 鉄道データを活用した配信条件 - 要件定義書（改訂版）

## 📋 目次

1. システムアーキテクチャとデータフロー
2. ユースケース分析サマリー
3. データ構造とテーブル連携
4. 必要な鉄道データ項目の整理
5. 既存データと不足データのギャップ分析
6. 配信条件の要件定義
7. UI設計への提言
8. 実装の優先順位
9. 技術的課題と解決策

---

## 1. システムアーキテクチャとデータフロー

### 1.1 全体フローチャート

```
┌─────────────────────────────────────────────────────────────┐
│ (1) 対象者抽出フェーズ                                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  統合DWH（鉄道データ + 気象データ）                            │
│    ├─ 会員情報テーブル                                        │
│    ├─ e5489予約テーブル                                       │
│    ├─ ICOCA利用実績テーブル                                   │
│    ├─ カード決済テーブル                                      │
│    └─ WESTERアプリテーブル                                    │
│           ↓                                                  │
│  【配信条件エンジン】                                          │
│    ├─ 気象条件フィルタリング                                   │
│    ├─ 鉄道利用条件フィルタリング                               │
│    └─ 購買履歴条件フィルタリング                               │
│           ↓                                                  │
│  【対象者リスト生成】                                          │
│    ├─ 共通会員ID (KAIIN_ID)                                  │
│    ├─ Popinfo ID（広告ID）← WESTERテーブルから紐付け          │
│    ├─ メールアドレス（ハッシュ化）                             │
│    └─ 電話番号（ハッシュ化）                                   │
│           ↓                                                  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ (2) キャンペーン同期フェーズ                                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  【広告媒体API連携】                                          │
│    ├─ Google Ads API                                         │
│    ├─ Meta (Facebook/Instagram) API                          │
│    ├─ Yahoo!広告 API                                         │
│    └─ geoLogic API                                           │
│           ↓                                                  │
│  各広告媒体にキャンペーンを作成/同期                           │
│    - キャンペーン名                                           │
│    - 予算設定                                                 │
│    - 配信期間                                                 │
│    - ターゲティング設定                                       │
│           ↓                                                  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ (3) カスタムオーディエンス登録フェーズ                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  【対象者データ送信】                                          │
│    ├─ Popinfo ID（広告ID）リスト                             │
│    ├─ メールアドレス（SHA256ハッシュ）                         │
│    └─ 電話番号（SHA256ハッシュ）                              │
│           ↓                                                  │
│  各広告媒体のカスタムオーディエンスとして登録                   │
│    - Google: Customer Match                                  │
│    - Meta: Custom Audiences                                  │
│    - Yahoo!: オーディエンスリスト                             │
│    - geoLogic: カスタムセグメント                             │
│           ↓                                                  │
│  マッチング処理（広告媒体側）                                  │
│    - 広告ID照合                                               │
│    - メール/電話番号照合                                       │
│    - マッチ率: 推定30-60%                                     │
│           ↓                                                  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ (4) 気象条件によるキャンペーン制御フェーズ                     │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  【気象データ取得】                                            │
│    - 外部気象APIサービス（ルグラン等）                         │
│    - リアルタイム気象情報                                      │
│    - 予報データ（1時間毎/3時間毎/日次）                        │
│           ↓                                                  │
│  【条件判定エンジン】                                          │
│    - 気温が33℃以上 → キャンペーンON                          │
│    - 降水量が10mm以上 → キャンペーンON                        │
│    - 晴天 → キャンペーンON                                    │
│    - 条件不一致 → キャンペーンOFF                             │
│           ↓                                                  │
│  【広告配信制御】                                              │
│    ├─ 広告媒体APIを経由してキャンペーンのON/OFF制御            │
│    ├─ 入札単価の自動調整（オプション）                         │
│    └─ 配信時間帯の制御（オプション）                           │
│           ↓                                                  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ (5) レポーティングフェーズ                                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  【広告媒体からデータ取得】                                    │
│    - インプレッション数                                       │
│    - クリック数、CTR                                          │
│    - コンバージョン数、CVR                                    │
│    - コスト、CPC、CPA                                         │
│           ↓                                                  │
│  【統合レポート生成】                                          │
│    ├─ キャンペーン別実績                                      │
│    ├─ 配信条件別効果測定                                      │
│    ├─ 気象条件別パフォーマンス                                │
│    └─ セグメント別分析                                        │
│           ↓                                                  │
│  【ダッシュボード表示】                                        │
│    - リアルタイムパフォーマンスモニター                        │
│    - 配信対象者数の推移                                       │
│    - ROI分析                                                 │
│           ↓                                                  │
└─────────────────────────────────────────────────────────────┘
```

---

### 1.2 データフェーズ別詳細

#### **フェーズ1: 対象者抽出**

**処理タイミング**: 
- 日次バッチ処理（AM 4:00）
- リアルタイム処理（オプション）

**処理内容**:
1. 配信条件設定の読み込み
2. 統合DWHへのクエリ実行
3. 条件に合致する会員IDリストの抽出
4. Popinfo IDの紐付け
5. メール/電話番号の取得とハッシュ化
6. 対象者リストファイルの生成

**出力データ形式**:
```csv
KAIIN_ID,POPINFO_ID,EMAIL_HASH,PHONE_HASH
ABC123...,POPXYZ...,a3f2e1...,b7c8d9...
```

---

#### **フェーズ2: キャンペーン同期**

**処理タイミング**: 
- 手動実行（初回設定時）
- 自動同期（日次/週次）

**広告媒体別API仕様**:

| 広告媒体 | API名 | 主な機能 |
|---|---|---|
| Google Ads | Google Ads API v15 | キャンペーン管理、Customer Match |
| Meta | Marketing API v19 | キャンペーン管理、Custom Audiences |
| Yahoo!広告 | Yahoo!広告 API v13 | キャンペーン管理、オーディエンスリスト |
| geoLogic | geoLogic API | 位置情報ターゲティング |

---

#### **フェーズ3: カスタムオーディエンス登録**

**データ送信方法**:
- **初期フェーズ（Metary 0.5）**: 手動CSV アップロード
- **次期フェーズ（Metary 1.0）**: API経由での自動登録

**マッチング精度**:
- Popinfo ID（広告ID）: **60-80%** （最も高精度）
- メールアドレス（ハッシュ化）: **40-60%**
- 電話番号（ハッシュ化）: **30-50%**

**総カバー率の向上**:
- Popinfo IDのみ: 約674万ID
- +メール/電話: カバー率さらに向上（推定+20-30%）

---

#### **フェーズ4: 気象条件制御**

**制御ロジック例**:

```python
# 例: 雨天時のタクシーアプリ広告
if 降水量 >= 10mm:
    campaign.status = "ENABLED"  # キャンペーンON
else:
    campaign.status = "PAUSED"   # キャンペーンOFF

# 例: 猛暑時のデリバリー広告
if 最高気温 >= 33 and 時刻 >= "18:00":
    campaign.status = "ENABLED"
    campaign.bid_modifier = 1.5  # 入札単価を1.5倍に
```

**更新頻度**:
- リアルタイム監視（1時間毎）
- 気象予報データの更新（3時間毎）

---

#### **フェーズ5: レポーティング**

**データ取得頻度**:
- リアルタイムダッシュボード: 1時間毎更新
- 日次レポート: 毎日AM 9:00
- 週次サマリー: 毎週月曜AM 10:00

---

## 2. データ構造とテーブル連携

### 2.1 テーブル間の連携キー

#### **【重要】主要テーブルの連携構造**

```
┌─────────────────────────────────────────────────────────────┐
│                      会員情報テーブル (KAIIN)                 │
│                  ★ 中心的なマスターテーブル                   │
├─────────────────────────────────────────────────────────────┤
│ 主キー: KAIIN_ID（共通会員ID）                                │
│                                                              │
│ - SEI_KNJ, MEI_KNJ（氏名）                                   │
│ - BIRTH_YMD（生年月日）                                       │
│ - SEIBETSU_CD（性別）                                        │
│ - JITAKU_TODOFUKEN_CD（都道府県）                            │
│ - MOYORIEKI_JPN（自宅最寄駅）★                               │
│ - TSUKIN_TSUGAKUSAKI_JPN（通勤・通学先）★                    │
│ - MAIL_ADDRESS_1/2/3（メールアドレス）                        │
│ - KEITAI_TEL（携帯電話番号）                                 │
└─────────────────────────────────────────────────────────────┘
         ↓ KAIIN_ID で連携
┌─────────────────────────────────────────────────────────────┐
│              WESTERサーバ保有データテーブル                   │
│                 ★ Popinfo ID（広告ID）の紐付け元             │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: KAIIN_ID                                           │
│                                                              │
│ - POPINFO_ID ★★★（広告配信に使用する識別子）                 │
│ - アプリインストール日                                        │
│ - 最終起動日時                                                │
│                                                              │
│ ※ 2026年2月までに、Popinfo IDと広告IDの紐付け開発完了予定     │
│ ※ カバー予定: 約674万ID                                      │
└─────────────────────────────────────────────────────────────┘
         ↓ KAIIN_ID (または KAIIN_A_KEY) で連携
┌─────────────────────────────────────────────────────────────┐
│            予約確定(e5489)テーブル                            │
│               E5489_YOYAKU_KAKUTEI                           │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: KAIIN_A_KEY（会員分析キー = J-WEST IDの代替キー）    │
│                                                              │
│ - UKETSUKE_ID（受付ID）★ 予約の一意識別子                    │
│ - HATSU_EKI_CD, HATSU_EKI_NAME（発駅）★                     │
│ - CHAKU_EKI_CD, CHAKU_EKI_NAME（着駅）★                     │
│ - JOSHA_YMD（乗車日）★★ 未来の予定含む                       │
│ - YOYAKU_YMD（予約日）                                       │
│ - SHOHIN_CD, SHOHIN_NAME（商品）                             │
│ - RIYO_KINGAKU（利用金額）                                   │
│ - ENQUETE_KBN（利用目的）★                                   │
└─────────────────────────────────────────────────────────────┘
         ↓ UKETSUKE_ID で連携
┌─────────────────────────────────────────────────────────────┐
│              行程確定(e5489)テーブル                          │
│                E5489_KOTEI_KAKUTEI                           │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: UKETSUKE_ID + KOKEN_NO（子券番号）                  │
│                                                              │
│ - KOKEN_KBN（子券区分: 往路/復路/フリー）                     │
│ - HATSU_YMD（出発日）                                        │
│ - HATSU_EKI_CD, CHAKU_EKI_CD（発着駅）★                     │
└─────────────────────────────────────────────────────────────┘
         ↓ UKETSUKE_ID + KOKEN_NO + ROSEN_NO で連携
┌─────────────────────────────────────────────────────────────┐
│              列車確定(e5489)テーブル                          │
│               E5489_RESSHA_KAKUTEI                           │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: UKETSUKE_ID + KOKEN_NO + ROSEN_NO                  │
│                                                              │
│ - 列車番号、列車名                                            │
│ - 発時刻、着時刻                                              │
│ - 車両番号、座席番号                                          │
└─────────────────────────────────────────────────────────────┘
         
         ↓ KAIIN_ID で連携
┌─────────────────────────────────────────────────────────────┐
│         ICOCA一件明細（収入系）テーブル                       │
│            ICOCA_IKKEN_MEISAI_SHUNYU                         │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: KAIIN_ID (推定: ICOCA IDと会員IDの紐付けテーブル経由) │
│                                                              │
│ - ICOCA_ID（ICOCAカード識別子）                               │
│ - 取引日時                                                    │
│ - 取引金額                                                    │
│ - 取引種別（チャージ/物販/鉄道利用）                           │
│ - 店舗コード/駅コード                                         │
└─────────────────────────────────────────────────────────────┘

         ↓ ICOCA_ID で連携
┌─────────────────────────────────────────────────────────────┐
│      ICカード出改札ID管理 一件明細（ID系）テーブル             │
│              ICCARD_DEKAISATSU_IKKEN_MEISAI                  │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: ICOCA_ID                                            │
│                                                              │
│ - 入場駅コード、入場時刻 ★★★                                 │
│ - 出場駅コード、出場時刻 ★★★                                 │
│ - 利用路線                                                    │
│ - 運賃金額                                                    │
│ - 定期券フラグ（要確認）★                                     │
└─────────────────────────────────────────────────────────────┘

         ↓ KAIIN_ID で連携
┌─────────────────────────────────────────────────────────────┐
│         カード事業（利用年月・会員）テーブル                   │
│           CARD_JIGYOU_RIYO_YM_KAIIN                          │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: KAIIN_ID                                            │
│                                                              │
│ - 利用年月 ★                                                 │
│ - 利用金額                                                    │
│ - 利用件数                                                    │
│ - 利用店舗カテゴリ ★★★                                       │
│   （ガソリンスタンド、ジム、航空券、etc.）                    │
└─────────────────────────────────────────────────────────────┘

         ↓ KAIIN_ID で連携
┌─────────────────────────────────────────────────────────────┐
│         カード事業（締め年月・会員）テーブル                   │
│           CARD_JIGYOU_SHIME_YM_KAIIN                         │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: KAIIN_ID                                            │
│                                                              │
│ - 締め年月                                                    │
│ - 請求金額                                                    │
│ - 支払い状況                                                  │
└─────────────────────────────────────────────────────────────┘

         ↓ KAIIN_ID で連携
┌─────────────────────────────────────────────────────────────┐
│         （WESTER）アプリ利用イベントテーブル                   │
│              WESTER_APP_EVENT                                │
├─────────────────────────────────────────────────────────────┤
│ 連携キー: KAIIN_ID (または POPINFO_ID)                        │
│                                                              │
│ - イベント種別（画面閲覧、ボタンタップ、etc.）                 │
│ - イベント発生日時                                            │
│ - 画面ID、機能ID                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.2 【重要課題】Popinfo ID（広告ID）の取得方法

#### **課題1: Popinfo IDの取得元テーブル**

**現状**:
- WESTERサーバ保有データテーブルに保存されている（予定）
- 2026年2月までに、Popinfo IDと広告IDの紐付け開発が完了予定
- カバー予定: 約674万ID

**連携方法**:
```sql
-- 配信対象者リストの生成SQL例
SELECT 
    k.KAIIN_ID,              -- 共通会員ID
    w.POPINFO_ID,            -- Popinfo ID（広告ID）★
    k.MAIL_ADDRESS_1,        -- メールアドレス
    k.KEITAI_TEL,            -- 携帯電話番号
    k.BIRTH_YMD,             -- 生年月日
    k.SEIBETSU_CD,           -- 性別
    k.JITAKU_TODOFUKEN_CD    -- 都道府県
FROM 
    KAIIN k                                    -- 会員情報
    INNER JOIN WESTER_SERVER_DATA w           -- WESTERサーバ保有データ
        ON k.KAIIN_ID = w.KAIIN_ID
WHERE
    -- 配信条件フィルタリング
    ... (条件に応じたWHERE句)
```

**データ出力形式**:
```csv
KAIIN_ID,POPINFO_ID,EMAIL_HASH,PHONE_HASH,AGE,GENDER,PREF
ABC123,POP456,sha256(email),sha256(phone),35,M,27
DEF789,POP012,sha256(email),sha256(phone),28,F,13
```

---

#### **課題2: ICOCA IDと会員IDの紐付け**

**現状の推定**:
- ICOCA一件明細テーブルに `KAIIN_ID` が直接存在する可能性
- または、ICOCA_ID ⇔ KAIIN_ID の中間紐付けテーブルが存在する可能性

**確認が必要なポイント**:
1. ✅ ICOCAテーブルに `KAIIN_ID` カラムは存在するか？
2. ✅ 存在しない場合、ICOCA_ID と KAIIN_ID の紐付けテーブルは？
3. ✅ SMART ICOCA会員のみが紐付け可能か？
4. ✅ 定期券の種別判定フラグは存在するか？

**連携SQL例（KAIIN_IDが存在する場合）**:
```sql
-- 大阪駅を過去30日間に5回以上利用した人
SELECT DISTINCT
    ic.KAIIN_ID
FROM 
    ICCARD_DEKAISATSU_IKKEN_MEISAI ic
WHERE
    (ic.NYUJO_EKI_CD = '1160101' OR ic.SHUTSUJO_EKI_CD = '1160101')  -- 大阪駅
    AND ic.RIYO_YMD >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY 
    ic.KAIIN_ID
HAVING 
    COUNT(*) >= 5
```

---

#### **課題3: e5489予約テーブルの会員ID**

**現状**:
- 予約確定テーブルには `KAIIN_A_KEY`（会員分析キー）が存在
- これは「J-WEST IDの代替キー」と記載されている

**確認が必要なポイント**:
1. ✅ `KAIIN_A_KEY` = `KAIIN_ID` なのか？
2. ✅ 別の識別子の場合、紐付けテーブルは？

**連携SQL例**:
```sql
-- 今後7日以内に金沢駅行きの切符を予約している人
SELECT DISTINCT
    y.KAIIN_A_KEY  -- または KAIIN_ID
FROM 
    E5489_YOYAKU_KAKUTEI y
WHERE
    y.CHAKU_EKI_CD = '1410602'  -- 金沢駅
    AND y.JOSHA_YMD BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '7 days'
    AND y.STATUS IN ('1', '2', '3')  -- 決済済/発券済/チケットレス
```

---

### 2.3 データ連携の全体マッピング

| テーブル名 | 連携キー | 備考 |
|---|---|---|
| **会員情報** | `KAIIN_ID` | 全テーブルの基準 |
| **WESTERサーバ** | `KAIIN_ID` → `POPINFO_ID` | ★広告ID取得元 |
| **予約確定(e5489)** | `KAIIN_A_KEY` | KAIIN_IDとの対応確認必要 |
| **行程確定(e5489)** | `UKETSUKE_ID` + `KOKEN_NO` | 予約確定から連携 |
| **列車確定(e5489)** | `UKETSUKE_ID` + `KOKEN_NO` + `ROSEN_NO` | 行程確定から連携 |
| **ICOCA一件明細** | `KAIIN_ID` or `ICOCA_ID` | 紐付け方法確認必要 |
| **ICOCA出改札** | `ICOCA_ID` | ICOCA一件明細から連携 |
| **カード事業** | `KAIIN_ID` | 直接連携可能 |
| **WESTERアプリイベント** | `KAIIN_ID` or `POPINFO_ID` | 連携キー確認必要 |

---

## 3. 技術的課題と解決策

### 3.1 【課題1】Popinfo ID（広告ID）の取得

#### **現状と課題**
- WESTERアプリをインストールしたユーザーのみPopinfo IDが発行される
- カバー率: 約674万ID / 全会員数（推定1000万以上？）
- カバー率が低い場合、広告配信のリーチが限定的になる

#### **解決策**

**短期（Metary 0.5）**:
1. ✅ Popinfo IDが存在する会員のみを対象に配信
2. ✅ 手動でDWHから対象者リストを抽出
3. ✅ CSVファイルで広告媒体に手動アップロード

**中期（Metary 1.0）**:
1. ✅ メールアドレスのハッシュ化による補完
   - 会員情報テーブルから `MAIL_ADDRESS_1/2/3` を取得
   - SHA256でハッシュ化
   - Google Customer Match / Meta Custom Audiences に送信
   - マッチング率: 40-60%

2. ✅ 電話番号のハッシュ化による補完
   - 会員情報テーブルから `KEITAI_TEL` を取得
   - SHA256でハッシュ化
   - 広告媒体に送信
   - マッチング率: 30-50%

**長期（Metary 2.0）**:
1. ⚪ WESTERアプリのインストール促進キャンペーン
2. ⚪ 他のJR西日本アプリとのID連携拡大
3. ⚪ Cookieレス時代に向けたファーストパーティデータ強化

---

### 3.2 【課題2】テーブル間の連携キーの不明確さ

#### **現状と課題**
- `KAIIN_A_KEY` と `KAIIN_ID` の関係が不明
- ICOCA_IDと会員IDの紐付け方法が不明
- 定期券種別の判定方法が不明

#### **解決策**

**ステップ1: データ調査**
```sql
-- 1. KAIIN_A_KEY と KAIIN_ID の対応確認
SELECT 
    KAIIN_A_KEY,
    KAIIN_ID,  -- このカラムが存在するか確認
    COUNT(*)
FROM 
    E5489_YOYAKU_KAKUTEI
GROUP BY 
    KAIIN_A_KEY, KAIIN_ID
LIMIT 10;

-- 2. ICOCAテーブルに KAIIN_ID が存在するか確認
DESCRIBE TABLE ICOCA_IKKEN_MEISAI_SHUNYU;
DESCRIBE TABLE ICCARD_DEKAISATSU_IKKEN_MEISAI;

-- 3. 定期券フラグの存在確認
SELECT DISTINCT
    TEIKI_KBN,  -- このようなカラムが存在するか
    TEIKI_FLG,
    KENSHU_CD   -- 券種コードから判定可能か
FROM 
    ICCARD_DEKAISATSU_IKKEN_MEISAI
LIMIT 100;
```

**ステップ2: 中間テーブルの確認**
```sql
-- ICOCA_ID ⇔ KAIIN_ID の紐付けテーブルが存在するか
SHOW TABLES LIKE '%ICOCA%';
SHOW TABLES LIKE '%KAIIN%';

-- 紐付けテーブルの例
SELECT * FROM ICOCA_KAIIN_RENKEI LIMIT 10;
```

**ステップ3: 代替案の検討**
- SMART ICOCA会員のみが紐付け可能な場合
  - 会員情報テーブルの `SICOCASERVICE_FLG` で絞り込み
- 定期券フラグが存在しない場合
  - 券種コード（`KENSHU_CD`）から推定
  - 利用頻度パターンから機械学習で推定

---

### 3.3 【課題3】リアルタイム性の確保

#### **現状と課題**
- 統合DWHへのデータ連携タイムラグ
- リアルタイム駅利用の検知が困難

#### **解決策**

**短期**:
- 日次バッチ処理で十分なユースケースに絞る
  - マイ駅利用者
  - 切符予約者（旅マエ）
  - 購買履歴ターゲティング

**中期**:
- 準リアルタイム処理（1時間毎）
  - 帰宅時刻ターゲティング
  - 気象条件に応じた配信制御

**長期**:
- ストリーミング処理の導入
  - Apache Kafka / AWS Kinesis
  - ICOCA出改札データのリアルタイム取り込み
  - 駅利用から5-10分以内の広告配信

---

### 3.4 【課題4】定期券情報の取得

#### **現状と課題**
- 通勤定期/通学定期の保有状況が明示的に判別できない可能性

#### **解決策**

**方法1: 定期券フラグが存在する場合**
```sql
SELECT 
    KAIIN_ID,
    NYUJO_EKI_CD AS HATSU_EKI,
    SHUTSUJO_EKI_CD AS CHAKU_EKI,
    TEIKI_KBN  -- '1': 通勤定期, '2': 通学定期
FROM 
    ICCARD_DEKAISATSU_IKKEN_MEISAI
WHERE
    TEIKI_FLG = TRUE
```

**方法2: 定期券フラグが存在しない場合（推定ロジック）**
```sql
-- 平日に同じ区間を頻繁に利用 → 定期券保有者と推定
WITH daily_usage AS (
    SELECT 
        KAIIN_ID,
        NYUJO_EKI_CD,
        SHUTSUJO_EKI_CD,
        DATE_TRUNC('month', RIYO_YMD) AS month,
        COUNT(*) AS usage_count,
        -- 平日（月〜金）の利用回数
        SUM(CASE WHEN EXTRACT(DOW FROM RIYO_YMD) BETWEEN 1 AND 5 THEN 1 ELSE 0 END) AS weekday_count
    FROM 
        ICCARD_DEKAISATSU_IKKEN_MEISAI
    WHERE
        RIYO_YMD >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY 
        KAIIN_ID, NYUJO_EKI_CD, SHUTSUJO_EKI_CD, month
)
SELECT 
    KAIIN_ID,
    NYUJO_EKI_CD AS TEIKI_HATSU_EKI,
    SHUTSUJO_EKI_CD AS TEIKI_CHAKU_EKI,
    '推定' AS TEIKI_HANTEI_METHOD
FROM 
    daily_usage
WHERE
    weekday_count >= 15  -- 月の平日のうち15日以上利用 → 定期券と推定
    AND usage_count >= 20
```

**方法3: 学生定期の判定（年齢で絞り込み）**
```sql
SELECT 
    k.KAIIN_ID,
    d.NYUJO_EKI_CD,
    d.SHUTSUJO_EKI_CD,
    TIMESTAMPDIFF(YEAR, k.BIRTH_YMD, CURRENT_DATE) AS age
FROM 
    KAIIN k
    INNER JOIN daily_usage d ON k.KAIIN_ID = d.KAIIN_ID
WHERE
    TIMESTAMPDIFF(YEAR, k.BIRTH_YMD, CURRENT_DATE) BETWEEN 15 AND 22  -- 学生年齢
    AND d.weekday_count >= 15
```

---

### 3.5 【課題5】経路検索（通過駅の推定）

#### **現状と課題**
- 発駅・着駅のペアから、その間の通過駅を推定する必要がある
- 例: 「大阪駅→京都駅」の経路上に「梅田駅、新大阪駅」があると判定

#### **解決策**

**方法1: 外部路線検索APIの利用（推奨）**

| API名 | 提供元 | 特徴 |
|---|---|---|
| **駅すぱあと Web サービス** | ヴァル研究所 | 国内最大級、JR含む全路線対応 |
| **Yahoo!路線情報API** | Yahoo! JAPAN | 無料枠あり、経路検索可能 |
| **Google Maps Directions API** | Google | 全世界対応、徒歩経路も含む |
| **HeartRails Express API** | HeartRails | 無料、シンプル |

**APIリクエスト例**:
```python
import requests

# 駅すぱあとの例
url = "https://api.ekispert.jp/v1/json/search/course/light"
params = {
    "key": "YOUR_API_KEY",
    "from": "1160101",  # 大阪駅
    "to": "1130909",    # 京都駅
    "via": "",
    "date": "20260220",
    "time": "1000"
}
response = requests.get(url, params=params)
course = response.json()

# 経路上の駅リストを取得
stations_on_route = [point["Station"]["code"] for point in course["ResultSet"]["Course"][0]["Route"]["Point"]]
# → ['1160101', '1160201', '1161101', '1130909']  (大阪、新大阪、高槻、京都)
```

**方法2: 自前の路線マスタテーブルを構築**
- JR西日本の駅マスタ + 路線情報
- 駅間の接続情報をグラフ構造で保持
- Dijkstraアルゴリズムで最短経路を計算

**実装の優先順位**:
- フェーズ1: 経路検索機能は実装しない（マイ駅・マイ区間のみで対応）
- フェーズ2: 外部API連携で実装
- フェーズ3: 自前の路線マスタで実装（コスト削減）

---

## 4. ユースケース分析サマリー

（前回の内容を継承）

### 4.1 全体概要
- **総ユースケース数**: 31件
- **広告主タイプ**: リアル 51.6% / ネット 48.4%
- **配信目的**: 来店誘導 54.8% / ブランディング 38.7% / ネット購入 6.5%

### 4.2 データ活用状況
- **鉄道利用データ**: 90.3%（28件）
- **購入データ**: 41.9%（13件）
- **気象データ**: 64.5%（20件）

### 4.3 鉄道データ活用パターンTOP5
1. 通勤/通学定期: 22件（71.0%）
2. マイ駅: 16件（51.6%）
3. 改札記録: 9件（29.0%）
4. マイ区間: 8件（25.8%）
5. 切符購入: 2件（6.5%）

---

## 5. 必要な鉄道データ項目の整理

（前回の内容を継承 + データ取得方法を明記）

### 5.1 配信条件として必要なデータ項目

#### **【A. 駅・区間データ】**

| データ項目 | ニーズ | データ取得方法 | SQL実装難易度 |
|---|---|---|---|
| **特定駅利用** | ⭐⭐⭐ | ICOCA出改札 → 入場駅/出場駅 | ★☆☆ 低 |
| **マイ駅** | ⭐⭐⭐ | ICOCA出改札 → 過去30日の駅別集計TOP3 | ★★☆ 中 |
| **特定区間利用** | ⭐⭐⭐ | ICOCA出改札 → 発着駅ペア | ★☆☆ 低 |
| **マイ区間** | ⭐⭐ | ICOCA出改札 → 過去30日の駅ペア集計TOP3 | ★★☆ 中 |
| **通勤定期（発着駅）** | ⭐⭐⭐ | ICOCA出改札 → 定期フラグ or 利用頻度推定 | ★★★ 高（要確認） |
| **通学定期（発着駅）** | ⭐⭐⭐ | ICOCA出改札 → 定期フラグ + 年齢 | ★★★ 高（要確認） |
| **経路上の駅** | ⭐⭐ | 外部API（駅すぱあと等） | ★★★ 高（API連携） |

---

#### **【B. 予約・切符データ】**

| データ項目 | ニーズ | データ取得方法 | SQL実装難易度 |
|---|---|---|---|
| **切符予約（未来）** | ⭐⭐⭐ | 予約確定(e5489) → JOSHA_YMD >= CURRENT_DATE | ★☆☆ 低 |
| **切符購入履歴** | ⭐⭐ | 予約確定(e5489) → JOSHA_YMD < CURRENT_DATE | ★☆☆ 低 |
| **利用目的** | ⭐⭐ | 予約確定(e5489) → ENQUETE_KBN | ★☆☆ 低 |

---

#### **【C. 時間帯データ】**

| データ項目 | ニーズ | データ取得方法 | SQL実装難易度 |
|---|---|---|---|
| **入場時刻・出場時刻** | ⭐⭐⭐ | ICOCA出改札 → NYUJO_JIKOKU, SHUTSUJO_JIKOKU | ★☆☆ 低 |
| **帰宅時刻推定** | ⭐⭐⭐ | ICOCA出改札 → 平日夕方の出場時刻平均 | ★★☆ 中 |

---

#### **【D. 属性データ】**

| データ項目 | ニーズ | データ取得方法 | SQL実装難易度 |
|---|---|---|---|
| **ビジネスパーソン** | ⭐⭐⭐ | 通勤定期あり + 年齢23歳以上 | ★★☆ 中 |
| **学生** | ⭐⭐⭐ | 通学定期あり + 年齢15-22歳 | ★★☆ 中 |
| **利用頻度** | ⭐⭐ | ICOCA出改札 → 週次/月次利用回数集計 | ★★☆ 中 |

---

#### **【E. 購買データ】**

| データ項目 | ニーズ | データ取得方法 | SQL実装難易度 |
|---|---|---|---|
| **カテゴリ別購買** | ⭐⭐⭐ | カード事業 → 利用店舗カテゴリ | ★☆☆ 低 |
| **競合店舗利用** | ⭐⭐⭐ | カード事業 → 店舗名マッチング | ★★☆ 中 |
| **自社商品購入** | ⭐⭐ | カード事業 → 自社店舗フラグ | ★☆☆ 低 |

---

## 6. 配信条件の要件定義

（前回の内容を継承 + データ取得SQLを追加）

### 6.1 新規追加する配信条件カテゴリ

#### 📍 **【新規カテゴリ1】 駅・区間条件**

##### **① 特定駅の利用**

**設定項目**:
- 対象駅: 駅名検索（複数選択可）
- 利用期間: 過去〇日間
- 利用回数: 〇回以上/以下/範囲
- 利用種別: 入場駅/出場駅/どちらでも
- いつの利用: 平日/休日/曜日指定

**データ取得SQL**:
```sql
-- 大阪駅を過去30日間に5回以上利用した会員
SELECT 
    k.KAIIN_ID,
    w.POPINFO_ID,
    COUNT(*) AS usage_count
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN ICCARD_DEKAISATSU_IKKEN_MEISAI ic ON k.KAIIN_ID = ic.KAIIN_ID
WHERE
    (ic.NYUJO_EKI_CD = '1160101' OR ic.SHUTSUJO_EKI_CD = '1160101')  -- 大阪駅
    AND ic.RIYO_YMD >= CURRENT_DATE - INTERVAL '30 days'
    AND EXTRACT(DOW FROM ic.RIYO_YMD) BETWEEN 1 AND 5  -- 平日のみ
GROUP BY 
    k.KAIIN_ID, w.POPINFO_ID
HAVING 
    COUNT(*) >= 5;
```

---

##### **② マイ駅（頻繁に利用する駅）**

**説明**: 過去30日間で最も利用頻度の高い駅TOP3を自動抽出

**データ生成SQL（バッチ処理）**:
```sql
-- マイ駅テーブルを事前生成
CREATE TABLE KAIIN_MY_EKI AS
WITH eki_usage AS (
    SELECT 
        KAIIN_ID,
        COALESCE(NYUJO_EKI_CD, SHUTSUJO_EKI_CD) AS EKI_CD,
        COUNT(*) AS usage_count,
        ROW_NUMBER() OVER (PARTITION BY KAIIN_ID ORDER BY COUNT(*) DESC) AS rank
    FROM 
        ICCARD_DEKAISATSU_IKKEN_MEISAI
    WHERE
        RIYO_YMD >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY 
        KAIIN_ID, EKI_CD
)
SELECT 
    KAIIN_ID,
    EKI_CD AS MY_EKI_CD,
    usage_count,
    rank AS MY_EKI_RANK
FROM 
    eki_usage
WHERE
    rank <= 3;  -- TOP3のみ保存
```

**配信対象者抽出SQL**:
```sql
-- 梅田駅がマイ駅（TOP3内）の会員
SELECT 
    k.KAIIN_ID,
    w.POPINFO_ID
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN KAIIN_MY_EKI me ON k.KAIIN_ID = me.KAIIN_ID
WHERE
    me.MY_EKI_CD = '1160201'  -- 梅田駅
    AND me.MY_EKI_RANK <= 3;
```

---

##### **③ 切符予約者（旅マエ配信）**

**説明**: 今後〇日以内に特定の駅へ向かう切符を予約している人

**データ取得SQL**:
```sql
-- 今後7日以内に金沢駅行きの切符を予約している会員
SELECT 
    k.KAIIN_ID,
    w.POPINFO_ID,
    y.CHAKU_EKI_NAME,
    y.JOSHA_YMD AS departure_date
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN E5489_YOYAKU_KAKUTEI y ON k.KAIIN_ID = y.KAIIN_A_KEY  -- ★要確認
WHERE
    y.CHAKU_EKI_CD = '1410602'  -- 金沢駅
    AND y.JOSHA_YMD BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '7 days'
    AND y.STATUS IN ('1', '2', '3');  -- 決済済/発券済/チケットレス
```

---

##### **④ 通勤定期保有者**

**説明**: 通勤定期を保有している人（発着駅指定可能）

**データ取得SQL（定期フラグが存在する場合）**:
```sql
-- 大阪駅⇔京都駅の通勤定期を保有している会員
SELECT DISTINCT
    k.KAIIN_ID,
    w.POPINFO_ID,
    ic.NYUJO_EKI_CD AS teiki_hatsu_eki,
    ic.SHUTSUJO_EKI_CD AS teiki_chaku_eki
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN ICCARD_DEKAISATSU_IKKEN_MEISAI ic ON k.KAIIN_ID = ic.KAIIN_ID
WHERE
    ic.TEIKI_FLG = TRUE  -- 定期券利用
    AND ic.TEIKI_KBN = '1'  -- '1': 通勤定期, '2': 通学定期
    AND (
        (ic.NYUJO_EKI_CD = '1160101' AND ic.SHUTSUJO_EKI_CD = '1130909')  -- 大阪→京都
        OR (ic.NYUJO_EKI_CD = '1130909' AND ic.SHUTSUJO_EKI_CD = '1160101')  -- 京都→大阪
    )
    AND ic.RIYO_YMD >= CURRENT_DATE - INTERVAL '7 days';  -- 最近利用している
```

**データ取得SQL（定期フラグが存在しない場合 - 推定ロジック）**:
```sql
-- 利用頻度パターンから通勤定期を推定
WITH commute_pattern AS (
    SELECT 
        KAIIN_ID,
        NYUJO_EKI_CD,
        SHUTSUJO_EKI_CD,
        COUNT(*) AS usage_count,
        SUM(CASE WHEN EXTRACT(DOW FROM RIYO_YMD) BETWEEN 1 AND 5 THEN 1 ELSE 0 END) AS weekday_count
    FROM 
        ICCARD_DEKAISATSU_IKKEN_MEISAI
    WHERE
        RIYO_YMD >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY 
        KAIIN_ID, NYUJO_EKI_CD, SHUTSUJO_EKI_CD
)
SELECT 
    k.KAIIN_ID,
    w.POPINFO_ID,
    cp.NYUJO_EKI_CD AS teiki_hatsu_eki,
    cp.SHUTSUJO_EKI_CD AS teiki_chaku_eki,
    cp.weekday_count AS usage_days
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN commute_pattern cp ON k.KAIIN_ID = cp.KAIIN_ID
WHERE
    cp.weekday_count >= 15  -- 月の平日のうち15日以上利用
    AND TIMESTAMPDIFF(YEAR, k.BIRTH_YMD, CURRENT_DATE) >= 23  -- ビジネスパーソン年齢
    AND (cp.NYUJO_EKI_CD = '1160101' OR cp.SHUTSUJO_EKI_CD = '1160101');  -- 大阪駅利用
```

---

##### **⑤ 帰宅時刻**

**説明**: 平均的な帰宅時刻に基づく配信

**データ生成SQL（バッチ処理）**:
```sql
-- 帰宅時刻テーブルを事前生成
CREATE TABLE KAIIN_KITAKU_JIKOKU AS
SELECT 
    KAIIN_ID,
    AVG(EXTRACT(HOUR FROM SHUTSUJO_JIKOKU) * 60 + EXTRACT(MINUTE FROM SHUTSUJO_JIKOKU)) AS avg_kitaku_min,
    COUNT(*) AS sample_count
FROM 
    ICCARD_DEKAISATSU_IKKEN_MEISAI
WHERE
    RIYO_YMD >= CURRENT_DATE - INTERVAL '30 days'
    AND EXTRACT(DOW FROM RIYO_YMD) BETWEEN 1 AND 5  -- 平日のみ
    AND EXTRACT(HOUR FROM SHUTSUJO_JIKOKU) BETWEEN 17 AND 23  -- 夕方〜夜
GROUP BY 
    KAIIN_ID
HAVING 
    COUNT(*) >= 10;  -- 最低10日分のデータがある人のみ
```

**配信対象者抽出SQL**:
```sql
-- 帰宅時刻が18:00-20:00の会員
SELECT 
    k.KAIIN_ID,
    w.POPINFO_ID,
    kj.avg_kitaku_min / 60 AS kitaku_hour,
    kj.avg_kitaku_min % 60 AS kitaku_minute
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN KAIIN_KITAKU_JIKOKU kj ON k.KAIIN_ID = kj.KAIIN_ID
WHERE
    kj.avg_kitaku_min BETWEEN (18 * 60) AND (20 * 60);  -- 18:00-20:00
```

---

#### 💳 **【新規カテゴリ5】 購買履歴条件**

##### **① 特定カテゴリ購買履歴**

**設定項目**:
- 店舗カテゴリ: ジム/ガソスタ/航空券 etc.
- 利用期間: 過去〇ヶ月
- 利用回数: 〇回以上/以下
- 利用金額: 合計〇円以上/以下

**データ取得SQL**:
```sql
-- ガソリンスタンド利用者（= 車保有者と推定）
SELECT 
    k.KAIIN_ID,
    w.POPINFO_ID,
    SUM(c.RIYO_KINGAKU) AS total_amount,
    COUNT(*) AS usage_count
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN CARD_JIGYOU_RIYO_YM_KAIIN c ON k.KAIIN_ID = c.KAIIN_ID
WHERE
    c.RIYO_TENPO_CATEGORY = 'ガソリンスタンド'  -- ★カテゴリコードの実際の値を確認
    AND c.RIYO_YM >= DATE_FORMAT(CURRENT_DATE - INTERVAL '6 months', '%Y%m')
GROUP BY 
    k.KAIIN_ID, w.POPINFO_ID
HAVING 
    COUNT(*) >= 3;  -- 過去6ヶ月で3回以上利用
```

---

##### **② 競合店舗利用者**

**説明**: 競合店舗での決済履歴がある人

**データ取得SQL**:
```sql
-- 競合ジムを利用している会員（自社ジムへの乗り換え促進）
SELECT 
    k.KAIIN_ID,
    w.POPINFO_ID,
    c.RIYO_TENPO_NAME AS competitor_gym
FROM 
    KAIIN k
    INNER JOIN WESTER_SERVER_DATA w ON k.KAIIN_ID = w.KAIIN_ID
    INNER JOIN CARD_JIGYOU_RIYO_YM_KAIIN c ON k.KAIIN_ID = c.KAIIN_ID
WHERE
    c.RIYO_TENPO_CATEGORY = 'スポーツジム'
    AND c.RIYO_TENPO_NAME IN ('コナミスポーツ', 'ティップネス', 'セントラルスポーツ')  -- 競合リスト
    AND c.RIYO_YM >= DATE_FORMAT(CURRENT_DATE - INTERVAL '3 months', '%Y%m')
GROUP BY 
    k.KAIIN_ID, w.POPINFO_ID, c.RIYO_TENPO_NAME;
```

---

## 7. UI設計への提言

（前回の内容を継承）

### 7.1 配信条件設定画面の全体構成

```
┌────────────────────────────────────────────────────────────┐
│ キャンペーン設定: wm_test                        [保存する] │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─ 左サイドバー ─┬─ 中央エリア（設定フォーム）─────────┐ │
│ │                │                                        │ │
│ │ [気象データ]   │  ┌──────────────────────────┐        │ │
│ │ ├ 気温         │  │ 【特定駅利用者】           │        │ │
│ │ ├ 気温差       │  │                            │        │ │
│ │ ├ 降水量       │  │ 対象駅: [大阪駅 ▼]         │        │ │
│ │ ├ 湿度         │  │                            │        │ │
│ │ ├ 風速         │  │ 利用期間: [過去30日間 ▼]   │        │ │
│ │ ├ 天気         │  │                            │        │ │
│ │ └ 花粉         │  │ 利用回数: [━●────] 5回以上│        │ │
│ │                │  │                            │        │ │
│ │ [鉄道データ]★  │  │ 利用種別: ☑入場 ☑出場     │        │ │
│ │ ├ 駅・区間     │  │                            │        │ │
│ │ ├ 定期券・予約 │  │ いつの利用:                │        │ │
│ │ ├ 時間帯       │  │ ☑月 ☑火 ☑水 ☑木 ☑金    │        │ │
│ │ ├ 属性         │  │ □土 □日                   │        │ │
│ │ └ 購買履歴     │  │                            │        │ │
│ │                │  │ [AND] [OR] [条件を追加]    │        │ │
│ │                │  └──────────────────────────┘        │ │
│ │                │                                        │ │
│ └────────────────┴────────────────────────────────────┘ │
│                                                             │
│ ┌─ 配信対象者プレビュー ─────────────────────────────┐  │
│ │ 📊 推定リーチ数: 約45,000人                        │  │
│ │                                                    │  │
│ │ ■ 条件内訳                                         │  │
│ │ ├─ 気象条件: 120,000人                            │  │
│ │ ├─ 駅条件: 80,000人                               │  │
│ │ └─ 購買条件: 60,000人                             │  │
│ │                                                    │  │
│ │ ■ セグメント分布                                   │  │
│ │ [グラフ表示]                                       │  │
│ └────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────┘
```

---

## 8. 実装の優先順位

### **フェーズ1（初期リリース - 必須）Priority: HIGH**

**実装期間**: 2-3ヶ月

| No | 配信条件 | データ取得難易度 | 実装優先度 |
|---|---|---|---|
| 1 | ✅ 特定駅利用者 | ★☆☆ 低 | 最優先 |
| 2 | ✅ マイ駅設定者 | ★★☆ 中（集計処理） | 最優先 |
| 3 | ✅ 特定区間利用者 | ★☆☆ 低 | 高 |
| 4 | ✅ 切符予約者（旅マエ） | ★☆☆ 低 | 最優先 |
| 5 | ✅ ビジネスパーソン判定 | ★★☆ 中（推定ロジック） | 高 |
| 6 | ✅ 学生判定 | ★★☆ 中（推定ロジック） | 高 |
| 7 | ✅ 特定カテゴリ購買履歴 | ★☆☆ 低 | 高 |

**成果物**:
- 対象者抽出SQL
- 配信条件設定UI
- バッチ処理スクリプト
- 広告媒体APIとの連携（手動アップロード）

---

### **フェーズ2（機能拡張）Priority: MEDIUM**

**実装期間**: 3-4ヶ月（フェーズ1完了後）

| No | 配信条件 | データ取得難易度 | 実装優先度 |
|---|---|---|---|
| 8 | ⚪ マイ区間設定者 | ★★☆ 中（集計処理） | 中 |
| 9 | ⚪ 通勤定期保有者 | ★★★ 高（定期判定ロジック） | 中 |
| 10 | ⚪ 通学定期保有者 | ★★★ 高（定期判定ロジック） | 中 |
| 11 | ⚪ 帰宅時刻 | ★★☆ 中（時刻推定ロジック） | 中 |
| 12 | ⚪ 鉄道利用頻度 | ★★☆ 中（集計処理） | 低 |
| 13 | ⚪ 競合店舗利用者 | ★★☆ 中（店舗マッチング） | 中 |
| 14 | ⚪ 自社商品購入者 | ★☆☆ 低 | 低 |

**成果物**:
- 高度な集計・分析ロジック
- 広告媒体APIとの自動連携
- メール/電話番号ハッシュ化処理

---

### **フェーズ3（高度な機能）Priority: LOW**

**実装期間**: 4-6ヶ月（フェーズ2完了後）

| No | 配信条件 | データ取得難易度 | 実装優先度 |
|---|---|---|---|
| 15 | 🔺 経路上の駅利用者 | ★★★ 高（外部API連携） | 低 |
| 16 | 🔺 リアルタイム駅利用 | ★★★ 高（リアルタイム連携） | 低 |
| 17 | 🔺 運行情報連動 | ★★★ 高（外部API連携） | 低 |

**成果物**:
- 外部API連携基盤
- リアルタイムストリーミング処理
- 高度なターゲティングロジック

---

## 9. データ処理パイプライン設計

### 9.1 バッチ処理フロー（日次）

```
■ AM 2:00 - DWHデータ更新
  └─ 前日分の鉄道利用データ、カード決済データがDWHに投入される

■ AM 4:00 - 集計・分析処理
  ├─ マイ駅/マイ区間の再集計（過去30日分）
  ├─ 利用頻度セグメントの更新
  ├─ 帰宅時刻の再計算
  ├─ 通勤定期/通学定期の推定
  └─ ビジネスパーソン/学生フラグの更新

■ AM 5:00 - 配信対象者抽出
  ├─ 各キャンペーンの配信条件を読み込み
  ├─ SQL実行して対象者リストを生成
  ├─ Popinfo ID（広告ID）の紐付け
  ├─ メール/電話番号のハッシュ化
  └─ 対象者リストファイルの出力（CSV）

■ AM 6:00 - 広告媒体への送信（Metary 1.0以降）
  ├─ Google Ads API → Customer Match更新
  ├─ Meta API → Custom Audiences更新
  ├─ Yahoo!広告 API → オーディエンスリスト更新
  └─ geoLogic API → カスタムセグメント更新

■ AM 7:00 - 気象条件チェック
  ├─ 気象APIから今日/明日の予報データ取得
  ├─ 各キャンペーンの気象条件を評価
  └─ 条件に合致するキャンペーンをON/OFF制御

■ 1時間毎 - 気象条件の監視
  └─ リアルタイム気象データで条件再評価 → キャンペーン制御
```

---

### 9.2 システムアーキテクチャ図

```
┌──────────────────────────────────────────────────────────┐
│                      統合DWH                              │
│   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐          │
│   │会員情報│ │e5489  │ │ICOCA  │ │カード │          │
│   │        │ │予約   │ │利用   │ │決済   │          │
│   └────────┘ └────────┘ └────────┘ └────────┘          │
└──────────────────────────────────────────────────────────┘
           ↓ データ連携
┌──────────────────────────────────────────────────────────┐
│              気象データ配信プラットフォーム                │
│                    (Metary System)                        │
│  ┌────────────────────────────────────────────────┐     │
│  │           配信条件エンジン                      │     │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐        │     │
│  │  │気象条件│ │鉄道条件│ │購買条件│ │時間条件│        │     │
│  │  └──────┘ └──────┘ └──────┘ └──────┘        │     │
│  └────────────────────────────────────────────────┘     │
│           ↓                                               │
│  ┌────────────────────────────────────────────────┐     │
│  │           対象者抽出エンジン                    │     │
│  │  - SQL実行                                      │     │
│  │  - Popinfo ID紐付け                             │     │
│  │  - ハッシュ化処理                               │     │
│  └────────────────────────────────────────────────┘     │
│           ↓                                               │
│  ┌────────────────────────────────────────────────┐     │
│  │         広告媒体API連携モジュール               │     │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐        │     │
│  │  │Google │ │Meta   │ │Yahoo!│ │geoLogic│       │     │
│  │  │Ads    │ │Ads    │ │広告  │ │       │        │     │
│  │  └──────┘ └──────┘ └──────┘ └──────┘        │     │
│  └────────────────────────────────────────────────┘     │
│           ↓                                               │
│  ┌────────────────────────────────────────────────┐     │
│  │         キャンペーン制御エンジン                │     │
│  │  - 気象条件監視                                 │     │
│  │  - ON/OFF制御                                   │     │
│  │  - 入札調整                                     │     │
│  └────────────────────────────────────────────────┘     │
│           ↓                                               │
│  ┌────────────────────────────────────────────────┐     │
│  │         レポーティングモジュール                │     │
│  │  - パフォーマンス集計                           │     │
│  │  - ダッシュボード生成                           │     │
│  └────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────┘
           ↓ 広告配信
┌──────────────────────────────────────────────────────────┐
│                    配信対象ユーザー                       │
│   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐          │
│   │WESTERアプリ│ │Web   │ │SNS   │ │その他 │          │
│   └────────┘ └────────┘ └────────┘ └────────┘          │
└──────────────────────────────────────────────────────────┘
```

---

## 10. まとめ

### 10.1 技術的課題の整理

| 課題 | 優先度 | 解決方法 | 確認事項 |
|---|---|---|---|
| **Popinfo IDの取得** | ★★★ 最優先 | WESTERサーバ保有データテーブルから紐付け | テーブル構造の確認 |
| **ICOCA IDと会員IDの連携** | ★★★ 最優先 | 紐付けテーブル or KAIIN_IDカラムの確認 | テーブル構造の確認 |
| **KAIIN_A_KEYの正体** | ★★★ 最優先 | KAIIN_IDとの関係を確認 | データサンプルの確認 |
| **定期券種別の判定** | ★★☆ 高 | 定期フラグ or 利用頻度推定 | ICOCAテーブルの確認 |
| **経路検索（通過駅）** | ★☆☆ 中 | 外部API連携（駅すぱあと等） | フェーズ2以降で検討 |
| **リアルタイム処理** | ★☆☆ 低 | ストリーミング基盤の構築 | フェーズ3以降で検討 |

---

### 10.2 次のアクション

#### **【即座に確認が必要な項目】**

1. ✅ **WESTERサーバ保有データテーブルの構造確認**
   - テーブル名
   - カラム定義（KAIIN_ID, POPINFO_ID）
   - レコード数

2. ✅ **ICOCAテーブルと会員情報の連携確認**
   - ICOCA_IKKEN_MEISAI に KAIIN_ID が存在するか
   - 存在しない場合、紐付けテーブルの有無
   - SMART ICOCA会員のみが紐付け可能か

3. ✅ **e5489予約テーブルの会員ID確認**
   - KAIIN_A_KEY = KAIIN_ID なのか
   - 別の識別子の場合、変換テーブルの有無

4. ✅ **定期券判定フラグの存在確認**
   - ICOCA出改札テーブルに定期券フラグが存在するか
   - 存在する場合、通勤/通学の区別は可能か

5. ✅ **カード決済テーブルの店舗カテゴリ**
   - 店舗カテゴリのコード体系
   - 主要カテゴリ一覧（ジム、ガソスタ、航空券等）

---

#### **【次のステップ】**

✅ **ステップ4完了**: 配信条件の要件定義（フローチャート対応版）

▶️ **ステップ5**: UI/UXモックアップの作成

**モックアップに含める内容**:
1. 🎨 配信条件設定画面（鉄道データ条件）
2. 🎨 駅名検索UIのサジェスト機能
3. 🎨 配信対象者プレビュー画面
4. 🎨 キャンペーン同期画面（広告媒体API連携）
5. 🎨 気象条件制御ダッシュボード
6. 🎨 レポーティング画面

---

## 📄 成果物

詳細な要件定義書（約25,000文字 + SQL例）を作成しました：

[📥 鉄道データ配信条件 要件定義書（改訂版）をダウンロード]

---

**📌 確認事項への回答をいただければ、すぐにモックアップ作成に着手いたします！**

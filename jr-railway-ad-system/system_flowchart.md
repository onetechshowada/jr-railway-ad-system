# システムフローチャート - 鉄道データ × 気象データ広告配信

## 📊 全体フロー図

```
┌─────────────────────────────────────────────────────────────┐
│  フェーズ1: 対象者抽出                                        │
│  Frequency: 日次バッチ (AM 4:00)                              │
└─────────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │    統合DWH (Data Warehouse)    │
        ├───────────────────────────────┤
        │ ・会員情報 (KAIIN)             │
        │ ・e5489予約 (YOYAKU_KAKUTEI)  │
        │ ・ICOCA利用 (DEKAISATSU)       │
        │ ・カード決済 (CARD_JIGYOU)     │
        │ ・WESTERアプリ                 │
        └───────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │   配信条件エンジン              │
        ├───────────────────────────────┤
        │ [気象条件]                     │
        │  ・気温 >= 33℃                │
        │  ・降水量 >= 10mm              │
        │  ・晴天/雨天/曇天              │
        │                                │
        │ [鉄道利用条件]                 │
        │  ・特定駅利用者                │
        │  ・マイ駅設定者                │
        │  ・切符予約者（未来）          │
        │  ・通勤/通学定期保有者         │
        │  ・帰宅時刻 18:00-20:00        │
        │                                │
        │ [購買履歴条件]                 │
        │  ・ガソスタ利用者（車保有）     │
        │  ・ジム会員                    │
        │  ・航空券購入者                │
        │                                │
        │ 【AND / OR ロジック】           │
        └───────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  対象者リスト生成               │
        ├───────────────────────────────┤
        │ Step 1: SQL実行                │
        │   └─ 条件に合致する会員ID抽出  │
        │                                │
        │ Step 2: Popinfo ID紐付け       │
        │   └─ WESTERテーブルと結合      │
        │                                │
        │ Step 3: メール/TEL取得         │
        │   └─ 会員情報から取得          │
        │                                │
        │ Step 4: ハッシュ化             │
        │   └─ SHA256で暗号化            │
        │                                │
        │ 出力: CSV/JSON                 │
        │  ├─ KAIIN_ID                   │
        │  ├─ POPINFO_ID (広告ID)        │
        │  ├─ EMAIL_HASH                 │
        │  └─ PHONE_HASH                 │
        └───────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  フェーズ2: キャンペーン同期                                  │
│  Frequency: 初回手動 → 後に自動化                            │
└─────────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  広告媒体API連携モジュール      │
        ├───────────────────────────────┤
        │                                │
        │  ┌──────────────┐             │
        │  │ Google Ads API│             │
        │  ├──────────────┤             │
        │  │ ・キャンペーン作成/更新      │
        │  │ ・広告グループ設定          │
        │  │ ・予算・入札設定            │
        │  │ ・配信期間設定              │
        │  └──────────────┘             │
        │         ↓                      │
        │  ┌──────────────┐             │
        │  │ Meta API      │             │
        │  │(FB/Instagram) │             │
        │  ├──────────────┤             │
        │  │ ・キャンペーン作成          │
        │  │ ・広告セット設定            │
        │  │ ・クリエイティブ登録        │
        │  └──────────────┘             │
        │         ↓                      │
        │  ┌──────────────┐             │
        │  │ Yahoo!広告 API│             │
        │  ├──────────────┤             │
        │  │ ・キャンペーン同期          │
        │  │ ・広告グループ設定          │
        │  └──────────────┘             │
        │         ↓                      │
        │  ┌──────────────┐             │
        │  │ geoLogic API  │             │
        │  ├──────────────┤             │
        │  │ ・位置情報ターゲティング    │
        │  │ ・カスタムセグメント        │
        │  └──────────────┘             │
        │                                │
        │  ✅ キャンペーンID発行          │
        │  ✅ ステータス: PAUSED (一時停止)│
        └───────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  フェーズ3: カスタムオーディエンス登録                        │
│  Frequency: 日次 (AM 6:00)                                   │
└─────────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  対象者データ送信               │
        ├───────────────────────────────┤
        │                                │
        │  【データ送信パターン】         │
        │                                │
        │  1️⃣ Popinfo ID (広告ID)       │
        │     └─ 最も高精度 (60-80%)     │
        │                                │
        │  2️⃣ メールアドレス (SHA256)    │
        │     └─ 中精度 (40-60%)         │
        │                                │
        │  3️⃣ 電話番号 (SHA256)          │
        │     └─ 中精度 (30-50%)         │
        │                                │
        │  【送信先】                    │
        │  ├─ Google Customer Match      │
        │  ├─ Meta Custom Audiences      │
        │  ├─ Yahoo! オーディエンスリスト│
        │  └─ geoLogic セグメント        │
        └───────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  広告媒体側のマッチング処理     │
        ├───────────────────────────────┤
        │                                │
        │  Step 1: データ受信             │
        │    └─ ハッシュ化リストを取得   │
        │                                │
        │  Step 2: 照合処理               │
        │    ├─ 広告ID照合               │
        │    ├─ メールアドレス照合       │
        │    └─ 電話番号照合             │
        │                                │
        │  Step 3: マッチング結果         │
        │    ├─ マッチ数: 45,000人       │
        │    ├─ マッチ率: 55%            │
        │    └─ リーチ可能数の確定       │
        │                                │
        │  ✅ カスタムオーディエンス作成完了│
        └───────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  フェーズ4: 気象条件によるキャンペーン制御                    │
│  Frequency: 1時間毎                                          │
└─────────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  気象データ取得                 │
        ├───────────────────────────────┤
        │                                │
        │  【外部気象APIサービス】        │
        │  (例: ルグラン、OpenWeather等) │
        │                                │
        │  取得データ:                   │
        │  ├─ 現在の気温: 35℃           │
        │  ├─ 降水量: 15mm/h             │
        │  ├─ 天気: 雨                   │
        │  ├─ 湿度: 80%                  │
        │  ├─ 風速: 5m/s                 │
        │  └─ 予報（1-3時間後）          │
        │                                │
        │  更新頻度: 1時間毎              │
        └───────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  条件判定エンジン               │
        ├───────────────────────────────┤
        │                                │
        │  【条件1】雨天 x 駅利用者       │
        │  IF 降水量 >= 10mm THEN        │
        │     キャンペーンON              │
        │  例: タクシーアプリ広告         │
        │                                │
        │  【条件2】猛暑 x 帰宅時刻       │
        │  IF 気温 >= 33℃ AND            │
        │     時刻 = 18:00-20:00 THEN    │
        │     キャンペーンON              │
        │  例: デリバリーサービス         │
        │                                │
        │  【条件3】週末晴天 x 観光予約   │
        │  IF 土日=晴れ AND              │
        │     切符予約済み THEN           │
        │     キャンペーンON              │
        │  例: ホテル予約サイト           │
        │                                │
        │  【条件不一致】                │
        │  ELSE キャンペーンOFF           │
        └───────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  広告配信制御API実行            │
        ├───────────────────────────────┤
        │                                │
        │  Google Ads:                   │
        │   campaign.status = "ENABLED"  │
        │   campaign.bid_modifier = 1.5x │
        │                                │
        │  Meta:                         │
        │   adset.status = "ACTIVE"      │
        │   budget.daily = $500          │
        │                                │
        │  Yahoo!広告:                   │
        │   campaign.status = "ACTIVE"   │
        │                                │
        │  ✅ 配信開始                    │
        └───────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  フェーズ5: レポーティング                                    │
│  Frequency: リアルタイム / 日次 / 週次                        │
└─────────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  広告媒体からデータ取得         │
        ├───────────────────────────────┤
        │                                │
        │  各広告媒体API経由:             │
        │                                │
        │  ├─ インプレッション数: 120,000│
        │  ├─ クリック数: 3,600 (CTR 3%)│
        │  ├─ コンバージョン数: 180      │
        │  ├─ CVR: 5%                    │
        │  ├─ コスト: $2,400             │
        │  ├─ CPC: $0.67                 │
        │  └─ CPA: $13.33                │
        └───────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  統合レポート生成               │
        ├───────────────────────────────┤
        │                                │
        │  【キャンペーン別実績】         │
        │  ├─ 大阪駅利用者 x 雨天        │
        │  │   └─ CPA: $12.50           │
        │  ├─ 帰宅時刻 x 猛暑            │
        │  │   └─ CPA: $14.80           │
        │  └─ 観光予約 x 週末晴天        │
        │      └─ CPA: $11.20            │
        │                                │
        │  【配信条件別効果測定】         │
        │  ├─ 気象条件のみ: CTR 2.5%    │
        │  ├─ 鉄道条件のみ: CTR 3.2%    │
        │  └─ 組み合わせ: CTR 4.1% ⭐    │
        │                                │
        │  【セグメント別分析】           │
        │  ├─ 年代別パフォーマンス       │
        │  ├─ 性別別パフォーマンス       │
        │  └─ 地域別パフォーマンス       │
        └───────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │  ダッシュボード表示             │
        ├───────────────────────────────┤
        │                                │
        │  📊 リアルタイムモニター        │
        │  ├─ 現在の配信状況             │
        │  ├─ 気象条件の状態             │
        │  └─ 配信対象者数の推移         │
        │                                │
        │  📈 パフォーマンスグラフ        │
        │  ├─ CTR推移                    │
        │  ├─ CVR推移                    │
        │  └─ コスト推移                 │
        │                                │
        │  💰 ROI分析                     │
        │  ├─ 投資額: $10,000            │
        │  ├─ 売上: $45,000              │
        │  └─ ROI: 350% ⭐               │
        └───────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 🔄 データフローの詳細

### 【フェーズ1】対象者抽出の詳細フロー

```
統合DWH
  ↓
┌─────────────────────────────────────┐
│ 配信条件設定                         │
│ ・気象: 気温 >= 33℃                 │
│ ・鉄道: 大阪駅利用者（過去30日）     │
│ ・購買: ガソスタ利用（過去6ヶ月）    │
│ ・AND ロジック                       │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ SQL生成                              │
│                                      │
│ SELECT k.KAIIN_ID, w.POPINFO_ID     │
│ FROM KAIIN k                         │
│ INNER JOIN WESTER_SERVER_DATA w     │
│   ON k.KAIIN_ID = w.KAIIN_ID        │
│ INNER JOIN ICCARD_DEKAISATSU ic     │
│   ON k.KAIIN_ID = ic.KAIIN_ID       │
│ INNER JOIN CARD_JIGYOU c            │
│   ON k.KAIIN_ID = c.KAIIN_ID        │
│ WHERE ...                            │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ 実行結果                             │
│ 該当会員数: 45,000人                 │
│ Popinfo IDカバー: 27,000人 (60%)    │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ メール/電話番号の取得とハッシュ化    │
│                                      │
│ SELECT                               │
│   KAIIN_ID,                          │
│   POPINFO_ID,                        │
│   SHA2(MAIL_ADDRESS_1, 256),        │
│   SHA2(KEITAI_TEL, 256)             │
│ FROM ...                             │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ CSVファイル出力                      │
│ audience_20260220.csv                │
│ ├─ 45,000行                          │
│ ├─ Popinfo ID: 27,000件              │
│ ├─ メールハッシュ: 40,000件          │
│ └─ 電話ハッシュ: 38,000件            │
└─────────────────────────────────────┘
```

---

### 【フェーズ3】カスタムオーディエンス登録の詳細

```
対象者リスト (45,000人)
  ↓
┌─────────────────────────────────────┐
│ Google Ads Customer Match           │
│                                      │
│ 送信:                                │
│ ├─ Popinfo ID: 27,000件              │
│ ├─ メールハッシュ: 40,000件          │
│ └─ 電話ハッシュ: 38,000件            │
│                                      │
│ マッチング結果:                      │
│ └─ マッチ: 24,500人 (マッチ率 54%)  │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ Meta Custom Audiences                │
│                                      │
│ 送信:                                │
│ ├─ Popinfo ID: 27,000件              │
│ ├─ メールハッシュ: 40,000件          │
│ └─ 電話ハッシュ: 38,000件            │
│                                      │
│ マッチング結果:                      │
│ └─ マッチ: 22,000人 (マッチ率 49%)  │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ 総リーチ可能数                       │
│ （重複排除後）                       │
│                                      │
│ Google: 24,500人                     │
│ Meta: 22,000人                       │
│ Yahoo!: 18,500人                     │
│ geoLogic: 21,000人                   │
│ ────────────────                     │
│ 合計: 約35,000-40,000人 (推定)      │
└─────────────────────────────────────┘
```

---

### 【フェーズ4】気象条件制御のリアルタイムフロー

```
毎時00分
  ↓
┌─────────────────────────────────────┐
│ 気象API呼び出し                      │
│ GET /weather/current                 │
│   ?location=osaka                    │
│   &params=temp,rain,weather          │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ レスポンス                           │
│ {                                    │
│   "temp": 35.2,                      │
│   "rain": 0,                         │
│   "weather": "clear",                │
│   "humidity": 65                     │
│ }                                    │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ 条件評価                             │
│                                      │
│ キャンペーン1:                       │
│ IF temp >= 33 AND rain == 0          │
│ → 条件一致 → ONにする                │
│                                      │
│ キャンペーン2:                       │
│ IF rain >= 10                        │
│ → 条件不一致 → OFFにする             │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ 広告媒体API実行                      │
│                                      │
│ POST /campaigns/12345/status         │
│ { "status": "ENABLED" }              │
│                                      │
│ POST /campaigns/67890/status         │
│ { "status": "PAUSED" }               │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ ログ記録                             │
│ 2026-02-20 14:00:                    │
│ ├─ Campaign 12345: OFF → ON          │
│ ├─ Campaign 67890: ON → OFF          │
│ └─ Reason: 気温35℃, 降水量0mm       │
└─────────────────────────────────────┘
```

---

## 📋 成果物一覧

| No | ドキュメント名 | 内容 |
|---|---|---|
| 1 | システムフローチャート | 本ドキュメント |
| 2 | 要件定義書（改訂版） | 配信条件の詳細仕様 + SQL例 |
| 3 | 技術的確認チェックシート | データ構造の確認事項 |

---

**📌 これらのドキュメントをもとに、実装フェーズに進むことができます！**
